name: C++ Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ build-essential
      
    - name: Compile main application
      run: |
        g++ -std=c++11 -pthread -O2 -o narrow_bridge main.cpp
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–æ"
      
    - name: Compile tests
      run: |
        g++ -std=c++11 -pthread -O2 -o test_runner test_narrow_bridge.cpp
        echo "‚úÖ –¢–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã"
      
    - name: Run tests
      run: |
        echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        ./test_runner
        TEST_RESULT=$?
        if [ $TEST_RESULT -eq 0 ]; then
          echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "üí• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã!"
          exit $TEST_RESULT
        fi
      
    - name: Test main application
      run: |
        echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        echo "3" | timeout 30s ./narrow_bridge || echo "–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ —Ä–∞–±–æ—Ç—É"
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ"
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-executables
        path: |
          narrow_bridge
          test_runner
        retention-days: 7
        
    - name: Create test report
      if: always()
      run: |
        echo "=== –û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò ==="
        echo "–í—Ä–µ–º—è: $(date)"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"